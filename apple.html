<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نصب برنامه</title>
    <script>
        function processLink() {
            let inputLink = document.getElementById("inputLink").value;

            // استخراج قسمت id از لینک ورودی
            let regex = /(?<=id\/)[^\/\?]+/;
            let match = inputLink.match(regex);

            if (match) {
                let id = match[0];
                let apiUrl = `https://app.appleapps.ir/ajax-api/init_ios_app_download/?ID=${id}`;

                // استفاده از CORS Anywhere برای ارسال درخواست GET
                const corsProxy = "https://cors-anywhere.herokuapp.com/";
                const finalUrl = corsProxy + apiUrl;

                // درخواست GET برای دریافت داده‌ها
                fetch(finalUrl, {
                    method: 'GET',
                    headers: {
                        'Cookie': 'wordpress_logged_in_8d6c024494df520c3c554a5fdb6cee64=09031111316%7C1741809955%7CYsGFyuIBHOanyRBjN28cZxjPcWsUputhdm9Igs1PNwE%7Cb0a008311378ad6881e1a0a1d86cf30d144a5f8fa71d9af50b72e271367759ef'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    let installURL = data.app_link;

                    // تطبیق با الگوی مورد نظر برای چک کردن لینک plist
                    let matchInstallURL = installURL.match(/(https:\/\/app.appleapps.ir\/).*(.plist)/i);

                    if (!matchInstallURL) {
                        alert("امکان نصب این برنامه وجود ندارد");
                    } else {
                        let installURLContent = matchInstallURL[0];

                        // تطبیق با الگوی ipa
                        let ipaMatch = installURLContent.match(/(https:\/\/dl).*(.apptrackr.ir).*(.ipa)/i);

                        if (ipaMatch) {
                            let IPAUrl = ipaMatch[0];
                            
                            // نمایش دکمه برای هدایت به آدرس scarlet://install=ipaURL
                            let button = document.createElement("button");
                            button.textContent = "نصب برنامه";
                            button.style.backgroundColor = "black";
                            button.style.color = "white";
                            button.style.padding = "10px 20px";
                            button.style.border = "none";
                            button.style.cursor = "pointer";
                            button.onclick = function() {
                                window.location.href = `scarlet://install=${IPAUrl}`;
                            };
                            document.getElementById("result").innerHTML = "";
                            document.getElementById("result").appendChild(button);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
            } else {
                alert("لطفاً یک لینک معتبر وارد کنید.");
            }
        }
    </script>
</head>
<body>
    <h2>لطفاً لینک برنامه را وارد کنید</h2>
    <input type="text" id="inputLink" placeholder="https://app.appleapps.ir/id/1893112/">
    <button onclick="processLink()">شروع</button>
    
    <div id="result"></div>
</body>
</html>
